<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ì••ì¶• ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF ì••ì¶• ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>
        <p>ì´ í˜ì´ì§€ëŠ” PDF ì••ì¶• ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ ë„êµ¬ì…ë‹ˆë‹¤.</p>

        <div class="test-section">
            <h3>1. PDF ë¡œë”© ë° ì••ì¶• í…ŒìŠ¤íŠ¸</h3>
            <p>PDF íŒŒì¼ë“¤ì„ ë¡œë“œí•˜ê³  ì••ì¶• ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <button onclick="testPdfCompression()" id="testBtn">PDF ì••ì¶• í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>PDFë¥¼ ë¡œë”©í•˜ê³  ì••ì¶• ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div class="result" id="compressionResult" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. ì••ì¶• í†µê³„</h3>
            <div class="stats" id="compressionStats" style="display: none;">
                <!-- í†µê³„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <div class="test-section">
            <h3>3. ì••ì¶• í’ˆì§ˆ ê²€ì¦</h3>
            <button onclick="validateCompression()" id="validateBtn" disabled>í’ˆì§ˆ ê²€ì¦</button>
            <div class="result" id="validationResult" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        let compressionResult = null;

        // PDF.js ë¡œë“œ
        async function loadPdfJs() {
            if (window.pdfjsLib) return;
            
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
            script.onload = () => {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            };
            document.head.appendChild(script);
            
            return new Promise((resolve) => {
                script.onload = () => {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
            });
        }

        // PDF íŒŒì‹± í•¨ìˆ˜
        async function parsePdfFromUrl(url) {
            try {
                const loadingTask = window.pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                let fullText = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                return fullText;
            } catch (error) {
                console.error(`Error parsing PDF from ${url}:`, error);
                throw error;
            }
        }

        // PDF ì••ì¶• í…ŒìŠ¤íŠ¸
        window.testPdfCompression = async function() {
            const testBtn = document.getElementById('testBtn');
            const loading = document.getElementById('loading');
            const result = document.getElementById('compressionResult');
            const stats = document.getElementById('compressionStats');
            const validateBtn = document.getElementById('validateBtn');

            testBtn.disabled = true;
            loading.style.display = 'block';
            result.style.display = 'none';
            stats.style.display = 'none';

            try {
                // PDF.js ë¡œë“œ
                await loadPdfJs();

                // PDF íŒŒì¼ ëª©ë¡
                const pdfFiles = [
                    '/chat8v/pdf/êµ­ë¯¼ê±´ê°•ì¦ì§„ë²•ë¥  ì‹œí–‰ë ¹ ì‹œí–‰ê·œì¹™(202508).pdf',
                    '/chat8v/pdf/ê¸ˆì—°êµ¬ì—­ ì§€ì • ê´€ë¦¬ ì—…ë¬´ì§€ì¹¨_2025ê°œì •íŒ.pdf',
                    '/chat8v/pdf/ê¸ˆì—°ì§€ì›ì„œë¹„ìŠ¤ í†µí•©ì‹œìŠ¤í…œ ì‚¬ìš©ìë§¤ë‰´ì–¼_ì§€ì—­ì‚¬íšŒ í†µí•©ê±´ê°•ì¦ì§„ì‚¬ì—… ì•ˆë‚´.pdf',
                    '/chat8v/pdf/ì§ˆì„œìœ„ë°˜í–‰ìœ„ê·œì œë²• ì‹œí–‰ë ¹(202101).pdf'
                ];

                console.log('PDF íŒŒì¼ë“¤ì„ ë¡œë”© ì¤‘...');
                const parsingPromises = pdfFiles.map(file => parsePdfFromUrl(file));
                const texts = await Promise.all(parsingPromises);
                const combinedText = texts.join('\n--- END OF DOCUMENT ---\n\n--- START OF DOCUMENT ---\n');

                console.log(`ì›ë³¸ PDF í…ìŠ¤íŠ¸ ë¡œë“œ ì™„ë£Œ: ${combinedText.length.toLocaleString()}ì`);

                // ê°„ë‹¨í•œ ì••ì¶• ì‹œë®¬ë ˆì´ì…˜
                const compressed = simulateCompression(combinedText);
                
                compressionResult = {
                    originalLength: combinedText.length,
                    compressedLength: compressed.length,
                    compressionRatio: compressed.length / combinedText.length,
                    estimatedTokens: Math.ceil(compressed.length / 4),
                    qualityScore: calculateQualityScore(combinedText, compressed)
                };

                // ê²°ê³¼ í‘œì‹œ
                result.textContent = `ì••ì¶• ì™„ë£Œ!\n\nì›ë³¸ í¬ê¸°: ${compressionResult.originalLength.toLocaleString()}ì\nì••ì¶• í›„ í¬ê¸°: ${compressionResult.compressedLength.toLocaleString()}ì\nì••ì¶•ë¥ : ${(compressionResult.compressionRatio * 100).toFixed(1)}%\nì˜ˆìƒ í† í° ìˆ˜: ${compressionResult.estimatedTokens.toLocaleString()}ê°œ\ní’ˆì§ˆ ì ìˆ˜: ${compressionResult.qualityScore.toFixed(1)}ì `;
                result.style.display = 'block';

                // í†µê³„ ì¹´ë“œ í‘œì‹œ
                displayStats(compressionResult);
                stats.style.display = 'grid';

                validateBtn.disabled = false;

            } catch (error) {
                result.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                testBtn.disabled = false;
            }
        };

        // ê°„ë‹¨í•œ ì••ì¶• ì‹œë®¬ë ˆì´ì…˜
        function simulateCompression(text) {
            // 1. ì¤‘ë³µ ë¼ì¸ ì œê±°
            const lines = text.split('\n');
            const uniqueLines = [...new Set(lines)];
            
            // 2. ë¹ˆ ë¼ì¸ ì •ë¦¬
            const cleanedLines = uniqueLines.filter(line => line.trim().length > 0);
            
            // 3. ì—°ì†ëœ ê³µë°± ì •ë¦¬
            const normalizedLines = cleanedLines.map(line => 
                line.replace(/\s+/g, ' ').trim()
            );
            
            // 4. ê¸¸ì´ ì œí•œ (ì•½ 80ë§Œìë¡œ ì œí•œ)
            let compressed = normalizedLines.join('\n');
            const maxLength = 800000;
            
            if (compressed.length > maxLength) {
                const chunks = splitIntoChunks(compressed, 10000);
                const selectedChunks = chunks.slice(0, Math.floor(maxLength / 10000));
                compressed = selectedChunks.join('\n---\n');
            }
            
            return compressed;
        }

        // ì²­í¬ ë¶„í• 
        function splitIntoChunks(text, chunkSize) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.slice(i, i + chunkSize));
            }
            return chunks;
        }

        // í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
        function calculateQualityScore(original, compressed) {
            let score = 0;
            
            // ì••ì¶•ë¥  ì ìˆ˜
            const compressionRatio = compressed.length / original.length;
            if (compressionRatio > 0.1 && compressionRatio < 0.5) {
                score += 30;
            } else if (compressionRatio > 0.05 && compressionRatio < 0.8) {
                score += 20;
            } else {
                score += 10;
            }
            
            // í‚¤ì›Œë“œ ë³´ì¡´ ì ìˆ˜
            const keywords = ['ê¸ˆì—°', 'ê±´ê°•ì¦ì§„', 'ì‹œí–‰ë ¹', 'ê·œì •', 'ì§€ì¹¨', 'ì—…ë¬´'];
            const originalKeywordCount = keywords.reduce((count, keyword) => {
                return count + (original.match(new RegExp(keyword, 'gi')) || []).length;
            }, 0);
            
            const compressedKeywordCount = keywords.reduce((count, keyword) => {
                return count + (compressed.match(new RegExp(keyword, 'gi')) || []).length;
            }, 0);
            
            if (originalKeywordCount > 0) {
                const keywordPreservationRatio = compressedKeywordCount / originalKeywordCount;
                score += Math.min(40, keywordPreservationRatio * 40);
            }
            
            // êµ¬ì¡°ì  ìš”ì†Œ ë³´ì¡´ ì ìˆ˜
            const structuralElements = ['ì œ', 'ì¡°', 'í•­', 'ëª©'];
            const originalStructuralCount = structuralElements.reduce((count, element) => {
                return count + (original.match(new RegExp(element, 'gi')) || []).length;
            }, 0);
            
            const compressedStructuralCount = structuralElements.reduce((count, element) => {
                return count + (compressed.match(new RegExp(element, 'gi')) || []).length;
            }, 0);
            
            if (originalStructuralCount > 0) {
                const structuralPreservationRatio = compressedStructuralCount / originalStructuralCount;
                score += Math.min(30, structuralPreservationRatio * 30);
            }
            
            return Math.min(100, score);
        }

        // í†µê³„ í‘œì‹œ
        function displayStats(result) {
            const statsContainer = document.getElementById('compressionStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${result.originalLength.toLocaleString()}</div>
                    <div class="stat-label">ì›ë³¸ í¬ê¸° (ì)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.compressedLength.toLocaleString()}</div>
                    <div class="stat-label">ì••ì¶• í›„ í¬ê¸° (ì)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(result.compressionRatio * 100).toFixed(1)}%</div>
                    <div class="stat-label">ì••ì¶•ë¥ </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.estimatedTokens.toLocaleString()}</div>
                    <div class="stat-label">ì˜ˆìƒ í† í° ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${result.qualityScore.toFixed(1)}ì </div>
                    <div class="stat-label">í’ˆì§ˆ ì ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(result.originalLength / 4 - result.estimatedTokens).toLocaleString()}</div>
                    <div class="stat-label">ì ˆì•½ëœ í† í°</div>
                </div>
            `;
        }

        // í’ˆì§ˆ ê²€ì¦
        window.validateCompression = function() {
            if (!compressionResult) {
                alert('ë¨¼ì € PDF ì••ì¶• í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const result = document.getElementById('validationResult');
            const warnings = [];
            const recommendations = [];

            // í† í° ìˆ˜ ê²€ì¦
            if (compressionResult.estimatedTokens > 200000) {
                warnings.push(`í† í° ìˆ˜ê°€ ë§ìŠµë‹ˆë‹¤: ${compressionResult.estimatedTokens.toLocaleString()}ê°œ`);
                recommendations.push('ë” ë§ì€ ì²­í¬ë¥¼ ì œê±°í•˜ê±°ë‚˜ ì••ì¶•ë¥ ì„ ë†’ì´ì„¸ìš”.');
            }

            // ì••ì¶•ë¥  ê²€ì¦
            if (compressionResult.compressionRatio < 0.05) {
                warnings.push(`ì••ì¶•ë¥ ì´ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤: ${(compressionResult.compressionRatio * 100).toFixed(1)}%`);
                recommendations.push('ì¤‘ìš”í•œ ì •ë³´ê°€ ì†ì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì••ì¶•ë¥ ì„ ì¡°ì •í•˜ì„¸ìš”.');
            }

            if (compressionResult.compressionRatio > 0.8) {
                warnings.push(`ì••ì¶•ë¥ ì´ ë‚®ìŠµë‹ˆë‹¤: ${(compressionResult.compressionRatio * 100).toFixed(1)}%`);
                recommendations.push('ë” ë§ì€ ì••ì¶•ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            }

            // í’ˆì§ˆ ì ìˆ˜ ê²€ì¦
            if (compressionResult.qualityScore < 60) {
                warnings.push(`í’ˆì§ˆ ì ìˆ˜ê°€ ë‚®ìŠµë‹ˆë‹¤: ${compressionResult.qualityScore.toFixed(1)}ì `);
                recommendations.push('í‚¤ì›Œë“œ ë³´ì¡´ì„ ê°œì„ í•˜ê±°ë‚˜ ì••ì¶• ì „ëµì„ ì¡°ì •í•˜ì„¸ìš”.');
            }

            let validationText = '=== ì••ì¶• í’ˆì§ˆ ê²€ì¦ ê²°ê³¼ ===\n\n';
            
            if (warnings.length === 0) {
                validationText += 'âœ… ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!\n\n';
            } else {
                validationText += 'âš ï¸ ê²½ê³ ì‚¬í•­:\n';
                warnings.forEach(warning => validationText += `- ${warning}\n`);
                validationText += '\n';
            }

            if (recommendations.length > 0) {
                validationText += 'ğŸ’¡ ê¶Œì¥ì‚¬í•­:\n';
                recommendations.forEach(rec => validationText += `- ${rec}\n`);
                validationText += '\n';
            }

            validationText += `ğŸ“Š ìƒì„¸ í†µê³„:\n`;
            validationText += `- ì›ë³¸ í¬ê¸°: ${compressionResult.originalLength.toLocaleString()}ì\n`;
            validationText += `- ì••ì¶• í›„ í¬ê¸°: ${compressionResult.compressedLength.toLocaleString()}ì\n`;
            validationText += `- ì••ì¶•ë¥ : ${(compressionResult.compressionRatio * 100).toFixed(1)}%\n`;
            validationText += `- ì˜ˆìƒ í† í° ìˆ˜: ${compressionResult.estimatedTokens.toLocaleString()}ê°œ\n`;
            validationText += `- í’ˆì§ˆ ì ìˆ˜: ${compressionResult.qualityScore.toFixed(1)}ì \n`;
            validationText += `- ì ˆì•½ëœ í† í°: ${(compressionResult.originalLength / 4 - compressionResult.estimatedTokens).toLocaleString()}ê°œ`;

            result.textContent = validationText;
            result.style.display = 'block';
        };
    </script>
</body>
</html>
