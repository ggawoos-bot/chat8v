name: Firestore PDF Processing

on:
  push:
    branches: [ master, main ]
    paths:
      - 'public/pdf/**'  # PDF íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      forceReprocess:
        description: 'ê°•ì œ ì¬ì²˜ë¦¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  process-pdfs:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Create required directories
      run: |
        echo "ğŸ“ í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
        mkdir -p public/data
        mkdir -p dist/data
        echo "âœ… ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"
        ls -la public/
        ls -la dist/
      
    - name: Verify PDF files
      run: |
        echo "ğŸ“‹ PDF íŒŒì¼ í™•ì¸ ì¤‘..."
        ls -la public/pdf/
        echo "ğŸ“„ PDF íŒŒì¼ ìˆ˜: $(ls public/pdf/*.pdf | wc -l)"
        
        # PDF íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "public/pdf/manifest.json" ]; then
          echo "âŒ manifest.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # PDF íŒŒì¼ í¬ê¸° í™•ì¸
        for pdf in public/pdf/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            echo "ğŸ“„ $(basename "$pdf"): ${size} bytes"
            if [ $size -lt 1000 ]; then
              echo "âš ï¸ ê²½ê³ : $(basename "$pdf") íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤."
            fi
          fi
        done
        
    - name: Process PDFs to Firestore
      run: |
        echo "ğŸš€ Firestore PDF ì²˜ë¦¬ ì‹œì‘..."
        echo "í™˜ê²½ë³€ìˆ˜ ì„¤ì •:"
        echo "  FORCE_REPROCESS: ${{ github.event.inputs.forceReprocess || false }}"
        
        # Node.js í™˜ê²½ ì„¤ì • (PDF íŒŒì‹± ìµœì í™”)
        export NODE_OPTIONS="--max-old-space-size=4096 --no-experimental-fetch"
        export PDF_PARSER_OPTIONS="--no-sandbox"
        export NODE_ENV="production"
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export FORCE_REPROCESS=${{ github.event.inputs.forceReprocess || false }}
        export GITHUB_ACTIONS=true
        
        # í´ë¦¬í•„ í™˜ê²½ ì„¤ì •
        export NODE_POLYFILLS="dom,canvas"
        
        echo "ğŸ”§ Node.js í™˜ê²½ ì„¤ì •:"
        echo "  NODE_OPTIONS: $NODE_OPTIONS"
        echo "  NODE_ENV: $NODE_ENV"
        echo "  NODE_POLYFILLS: $NODE_POLYFILLS"
        
        # Firestore PDF ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        echo "ğŸ”„ Firestore PDF ì²˜ë¦¬ ì‹œë„..."
        if node scripts/migrate-to-firestore.js; then
          echo "âœ… Firestore PDF ì²˜ë¦¬ ì„±ê³µ!"
        else
          echo "âŒ Firestore PDF ì²˜ë¦¬ ì‹¤íŒ¨!"
          exit 1
        fi
        
        echo "âœ… Firestore PDF ì²˜ë¦¬ ì™„ë£Œ!"
      env:
        VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
        FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
        
    - name: Validate Firestore data
      run: |
        echo "ğŸ” Firestore ë°ì´í„° ê²€ì¦ ì¤‘..."
        
        # Firestore ì—°ê²° í…ŒìŠ¤íŠ¸
        echo "ğŸ”„ Firestore ì—°ê²° í…ŒìŠ¤íŠ¸..."
        if node scripts/validate-firestore-data.js; then
          echo "âœ… Firestore ë°ì´í„° ê²€ì¦ ì„±ê³µ!"
        else
          echo "âŒ Firestore ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨!"
          exit 1
        fi
        
        echo "ğŸ“Š Firestore ì²˜ë¦¬ ê²°ê³¼:"
        echo "  ë°ì´í„°ë² ì´ìŠ¤: Firestore"
        echo "  ì»¬ë ‰ì…˜: pdf_documents, pdf_chunks"
        echo "  ê²€ì¦: ì™„ë£Œ"
        
    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Update Firestore data with PDF processing [skip ci]

        - ë°ì´í„°ë² ì´ìŠ¤: Firestore
        - ì²˜ë¦¬ ì‹œê°„: $(date)
        - í™˜ê²½: GitHub Actions
        - í’ˆì§ˆ ê°œì„ : Firestore ìµœì í™”, ì‹¤ì‹œê°„ ê²€ìƒ‰"
        git push
        
    - name: Build and deploy
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "ğŸ—ï¸ ë¹Œë“œ ì‹œì‘..."
        npm run build
        echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
      env:
        VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        
    - name: Setup Pages
      if: steps.changes.outputs.changes == 'true'
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      if: steps.changes.outputs.changes == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
        
    - name: Deploy to GitHub Pages
      if: steps.changes.outputs.changes == 'true'
      uses: actions/deploy-pages@v4
      
    - name: Notify completion
      run: |
        echo "ğŸ‰ Firestore PDF ì²˜ë¦¬ ì™„ë£Œ!"
        echo "ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:"
        echo "  ë°ì´í„°ë² ì´ìŠ¤: Firestore"
        echo "  ì»¬ë ‰ì…˜: pdf_documents, pdf_chunks"
        echo "  ë³€ê²½ì‚¬í•­: ${{ steps.changes.outputs.changes }}"
        echo "  ê²€ìƒ‰: ì‹¤ì‹œê°„ Firestore ê²€ìƒ‰"
        echo "  í’ˆì§ˆ: ìµœì í™”ë¨"
