<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF ë·°ì–´</title>
  <link rel="stylesheet" href="styles/pdf-viewer.css">
</head>
<body>
  <div id="pdf-viewer-container">
    <div class="header">
      <div class="header-top">
        <div class="title" id="pdf-title">PDF ë¡œë”© ì¤‘...</div>
        <div class="controls">
          <button id="prev-btn" disabled>â† ì´ì „</button>
          <div class="page-info">
            <span>í˜ì´ì§€</span>
            <input type="number" id="page-input" min="1" value="1" disabled>
            <span id="total-pages">/ ?</span>
          </div>
          <button id="next-btn" disabled>ë‹¤ìŒ â†’</button>
          <button id="close-btn">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="search-container">
        <input 
          type="text" 
          id="search-input" 
          class="search-input" 
          placeholder="í˜„ì¬ ë¬¸ì„œì—ì„œ ê²€ìƒ‰..."
          autocomplete="off"
        />
        <button id="search-button" class="search-button" disabled>ê²€ìƒ‰</button>
        <div class="search-nav" id="search-nav" style="display: none;">
          <button id="search-prev-btn" disabled>â€¹</button>
          <span id="search-counter" style="font-size: 12px; color: #666; padding: 0 8px;">0/0</span>
          <button id="search-next-btn" disabled>â€º</button>
        </div>
      </div>
    </div>
    <div class="viewer-wrapper" id="viewer-wrapper">
      <div class="loading">PDF ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="scripts/pdf-highlight-reference.js"></script>
  <script src="scripts/pdf-highlight-search.js"></script>
  <script src="scripts/pdf-renderer-reference.js"></script>
  <script src="scripts/pdf-renderer-search.js"></script>
  <script src="scripts/pdf-search.js"></script>
  <script>
    // PDF.js Worker ì„¤ì •
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const pdfUrlParam = urlParams.get('url') || '';
    const pdfUrl = pdfUrlParam ? decodeURIComponent(pdfUrlParam) : '';
    const initialPage = parseInt(urlParams.get('page') || '1', 10);
    const titleParam = urlParams.get('title') || '';
    const title = titleParam ? decodeURIComponent(titleParam) : 'PDF ë¬¸ì„œ';
    
    // í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸° (ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•˜ê²Œ)
    const highlightParam = urlParams.get('highlight') || '';
    let searchTextParam = urlParams.get('searchText') || '';
    let highlightKeywords = highlightParam 
      ? highlightParam.split(',').filter(k => k.trim().length > 0).map(k => decodeURIComponent(k.trim()))
      : [];
    
    console.log('ğŸ“„ PDF ë·°ì–´ ì´ˆê¸°í™”:', {
      pdfUrl: pdfUrl,
      initialPage: initialPage,
      title: title,
      highlightKeywords: highlightKeywords,
      searchText: searchTextParam.substring(0, 50),
      fullUrl: window.location.href
    });
    
    if (!pdfUrl) {
      const errorHtml = '<div class="error"><div>âŒ PDF URLì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div><div class="error-message">URL íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div></div>';
      document.getElementById('viewer-wrapper').innerHTML = errorHtml;
      console.error('âŒ PDF URLì´ ì—†ìŠµë‹ˆë‹¤. URL íŒŒë¼ë¯¸í„°:', window.location.search);
      throw new Error('PDF URLì´ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ì œëª© ì„¤ì •
    document.getElementById('pdf-title').textContent = title;
    
    // âœ… ê²€ìƒ‰ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ í•¨ìˆ˜ (ì—¬ëŸ¬ ì‹œì ì—ì„œ í˜¸ì¶œ)
    function focusSearchInput() {
      const searchInput = document.getElementById('search-input');
      if (searchInput && document.activeElement !== searchInput) {
        try {
          searchInput.focus();
          console.log('âœ… ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ì„¤ì •');
        } catch (e) {
          console.warn('âš ï¸ í¬ì»¤ìŠ¤ ì„¤ì • ì‹¤íŒ¨:', e);
        }
      }
    }
    
    // âœ… DOM ë¡œë“œ ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ì‹œë„
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(focusSearchInput, 100);
      });
    } else {
      setTimeout(focusSearchInput, 100);
    }
    
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ëª¨ë“ˆì—ì„œ ì‚¬ìš©)
    let pdfDoc = null;
    let currentPage = initialPage;
    let numPages = 0;
    // âœ… ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬: ì°¸ì¡°ìš©ê³¼ ê²€ìƒ‰ìš© ë Œë”ë§ ìƒíƒœ ë¶„ë¦¬
    let referenceRendering = false;
    let referencePending = null;
    let searchRendering = false;
    let searchPending = null;
    // âœ… PDF ë¡œë“œ ì „ ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ëŠ” í
    const queuedMessages = [];
    
    // âœ… ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬: ì°¸ì¡° ë·°ì–´ì™€ ê²€ìƒ‰ ë·°ì–´ ë¶„ë¦¬
    window.referenceViewer = {
      currentPage: initialPage,
      rendering: false,
      pending: null,
      mode: 'reference'
    };
    
    window.searchViewer = {
      currentPage: initialPage,
      rendering: false,
      pending: null,
      mode: 'search',
      searchText: '',
      searchIndex: -1,
      searchResults: []
    };
    
    // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (ëª¨ë“ˆì—ì„œ ì‚¬ìš© - í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
    window.pdfDoc = null;
    window.currentPage = currentPage;
    window.numPages = numPages;
    
    // âœ… ë·°ì–´ ëª¨ë“œ ì„¤ì • (ê¸°ë³¸ê°’: reference)
    window.viewerMode = 'reference';
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (í•˜ì´ë¼ì´íŠ¸ ëª¨ë“ˆì—ì„œ ì‚¬ìš©)
    const viewerWrapper = document.getElementById('viewer-wrapper');
    window.viewerWrapper = viewerWrapper; // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ
    viewerWrapper.innerHTML = '';
    
    // ìº”ë²„ìŠ¤ì™€ í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼ ë‹´ì„ ì»¨í…Œì´ë„ˆ ìƒì„±
    const pageContainer = document.createElement('div');
    pageContainer.style.position = 'relative';
    pageContainer.style.display = 'inline-block';
    viewerWrapper.appendChild(pageContainer);
    pageContainer.appendChild(canvas);
    
    // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì»¨í…Œì´ë„ˆ ìƒì„±
    const textLayerDiv = document.createElement('div');
    textLayerDiv.className = 'textLayer';
    pageContainer.appendChild(textLayerDiv);
    
    // ìš”ì†Œ ì°¸ì¡°
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInput = document.getElementById('page-input');
    const totalPagesSpan = document.getElementById('total-pages');
    const closeBtn = document.getElementById('close-btn');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchNav = document.getElementById('search-nav');
    const searchPrevBtn = document.getElementById('search-prev-btn');
    const searchNextBtn = document.getElementById('search-next-btn');
    const searchCounter = document.getElementById('search-counter');
    
    // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (ê²€ìƒ‰ ëª¨ë“ˆì—ì„œ ì‚¬ìš©)
    window.searchButton = searchButton;
    window.searchNav = searchNav;
    window.searchPrevBtn = searchPrevBtn;
    window.searchNextBtn = searchNextBtn;
    window.searchCounter = searchCounter;
    
    // ê²€ìƒ‰ ê´€ë ¨ ë³€ìˆ˜ (ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì´ë™)
    // window.searchViewerì— í†µí•©ë¨
    
    // PDF ë¡œë“œ
    console.log('ğŸ“¥ PDF ë¡œë”© ì‹œì‘:', pdfUrl);
    pdfjsLib.getDocument({
      url: pdfUrl,
      httpHeaders: {},
      withCredentials: false
    }).promise.then((pdf) => {
      pdfDoc = pdf;
      window.pdfDoc = pdf; // ì „ì—­ ìŠ¤ì½”í”„ ì—…ë°ì´íŠ¸
      numPages = pdf.numPages;
      window.numPages = numPages; // ì „ì—­ ìŠ¤ì½”í”„ ì—…ë°ì´íŠ¸
      
      totalPagesSpan.textContent = `/ ${numPages}`;
      pageInput.max = numPages;
      pageInput.disabled = false;
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      searchButton.disabled = false;
      
      // âœ… URLì—ì„œ ê²€ìƒ‰ í…ìŠ¤íŠ¸ê°€ ìˆì–´ë„ ê²€ìƒ‰ì°½ì— ìë™ ì…ë ¥í•˜ì§€ ì•ŠìŒ
      // (í•˜ì´ë¼ì´íŠ¸ëŠ” searchTextParamì„ ì‚¬ìš©í•˜ë¯€ë¡œ ìœ ì§€)
      // if (searchTextParam) {
      //   searchInput.value = searchTextParam;
      //   performSearch(searchTextParam);
      // }
      
      // âœ… íì— ìŒ“ì¸ ë©”ì‹œì§€ ì²˜ë¦¬ (PDF ë¡œë“œ ì „ì— ë°›ì€ ë©”ì‹œì§€ë“¤)
      if (queuedMessages.length > 0) {
        console.log(`ğŸ“¥ [ì°¸ì¡°] íì— ìŒ“ì¸ ${queuedMessages.length}ê°œ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œì‘`);
        queuedMessages.forEach((msg) => {
          processChangePageMessage(msg);
        });
        queuedMessages.length = 0; // í ë¹„ìš°ê¸°
      }
      
      // ì´ˆê¸° í˜ì´ì§€ ë Œë”ë§ (í ì²˜ë¦¬ í›„, ë§ˆì§€ë§‰ ë©”ì‹œì§€ì˜ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒìœ¼ë¡œ, ì—†ìœ¼ë©´ initialPageë¡œ)
      // ì°¸ì¡° ëª¨ë“œë¡œ ì‹œì‘
      window.viewerMode = 'reference';
      window.referenceViewer.currentPage = currentPage;
      renderPage(currentPage);
      
      console.log('âœ… PDF ë¡œë“œ ì™„ë£Œ:', numPages, 'í˜ì´ì§€');
      
      // âœ… ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— ìë™ í¬ì»¤ìŠ¤ (PDF ë¡œë“œ ì™„ë£Œ í›„)
      setTimeout(focusSearchInput, 300);
    }).catch((error) => {
      console.error('âŒ PDF ë¡œë“œ ì˜¤ë¥˜:', error);
      console.error('âŒ PDF URL:', pdfUrl);
      console.error('âŒ ì „ì²´ ì—ëŸ¬ ê°ì²´:', error);
      
      let errorMessage = error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      if (error.name === 'MissingPDFException') {
        errorMessage = 'PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.';
      } else if (error.name === 'InvalidPDFException') {
        errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ PDF íŒŒì¼ì…ë‹ˆë‹¤.';
      } else if (error.message && error.message.includes('Network')) {
        errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.';
      } else if (error.message && error.message.includes('CORS')) {
        errorMessage = 'CORS ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
      }
      
      viewerWrapper.innerHTML = `
        <div class="error">
          <div>âŒ PDF ë¡œë“œ ì‹¤íŒ¨</div>
          <div class="error-message">${errorMessage}</div>
          <div class="error-message" style="margin-top: 8px; font-size: 12px; color: #999;">URL: ${pdfUrl}</div>
          <div class="error-message" style="margin-top: 4px; font-size: 11px; color: #aaa;">ì—ëŸ¬ íƒ€ì…: ${error.name || 'Unknown'}</div>
        </div>
      `;
    });
    
    // í˜ì´ì§€ ë Œë”ë§ (í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë° í•˜ì´ë¼ì´íŠ¸ í¬í•¨)
    function renderPage(num) {
      const currentMode = window.viewerMode || 'reference';
      const isSearchMode = currentMode === 'search';
      
      console.log(`ğŸ”„ renderPage í˜¸ì¶œ: ${num} (í˜„ì¬: ${currentPage}, ëª¨ë“œ: ${currentMode}, ë Œë”ë§ ì¤‘: ${isSearchMode ? searchRendering : referenceRendering})`);
      
      if (isSearchMode) {
        // ê²€ìƒ‰ ëª¨ë“œ: ê²€ìƒ‰ìš© ë Œë”ëŸ¬ ì‚¬ìš©
        searchRendering = true;
        window.searchViewer.rendering = true;
        const searchIndex = window.searchViewer.searchIndex || 0;
        
        renderPageForSearch(
          num,
          canvas,
          ctx,
          textLayerDiv,
          {
            searchText: window.searchViewer.searchText,
            searchIndex: searchIndex,
            onComplete: (pageNum) => {
              searchRendering = false;
              window.searchViewer.rendering = false;
              console.log(`âœ… [ê²€ìƒ‰] í˜ì´ì§€ ${pageNum} ë Œë”ë§ ì™„ì „íˆ ì™„ë£Œ`);
          
          // âœ… ì´ˆê¸° í˜ì´ì§€ ë Œë”ë§ ì™„ë£Œ ì‹œ ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
              if (pageNum === currentPage && pageNum === initialPage) {
            setTimeout(focusSearchInput, 100);
          }
          
              // ëŒ€ê¸° ì¤‘ì¸ í˜ì´ì§€ ì²˜ë¦¬
              if (searchPending !== null) {
                const pending = searchPending;
                searchPending = null;
                window.searchViewer.pending = null;
                console.log(`ğŸ“„ [ê²€ìƒ‰] ëŒ€ê¸° ì¤‘ì¸ í˜ì´ì§€ ${pending} ë Œë”ë§ ì‹œì‘`);
                renderPage(pending);
              }
            }
          }
        );
      } else {
        // ì°¸ì¡° ëª¨ë“œ: ì°¸ì¡°ìš© ë Œë”ëŸ¬ ì‚¬ìš©
        referenceRendering = true;
        window.referenceViewer.rendering = true;
        
        renderPageForReference(
          num,
          canvas,
          ctx,
          textLayerDiv,
          {
            highlightKeywords: highlightKeywords,
            searchText: searchTextParam,
            onComplete: (pageNum) => {
              referenceRendering = false;
              window.referenceViewer.rendering = false;
              console.log(`âœ… [ì°¸ì¡°] í˜ì´ì§€ ${pageNum} ë Œë”ë§ ì™„ì „íˆ ì™„ë£Œ`);
          
          // âœ… ì´ˆê¸° í˜ì´ì§€ ë Œë”ë§ ì™„ë£Œ ì‹œ ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
              if (pageNum === currentPage && pageNum === initialPage) {
            setTimeout(focusSearchInput, 100);
          }
          
              // ëŒ€ê¸° ì¤‘ì¸ í˜ì´ì§€ ì²˜ë¦¬
              if (referencePending !== null) {
                const pending = referencePending;
                referencePending = null;
                window.referenceViewer.pending = null;
                console.log(`ğŸ“„ [ì°¸ì¡°] ëŒ€ê¸° ì¤‘ì¸ í˜ì´ì§€ ${pending} ë Œë”ë§ ì‹œì‘`);
            renderPage(pending);
          }
            }
          }
        );
          }
      
      // âœ… í˜ì´ì§€ ì…ë ¥ í•„ë“œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
      pageInput.value = num;
      updateButtons();
    }
    
    
    // í˜ì´ì§€ ë³€ê²½ í
    function queueRenderPage(num) {
      const currentMode = window.viewerMode || 'reference';
      const isSearchMode = currentMode === 'search';
      const isRendering = isSearchMode ? searchRendering : referenceRendering;
      const pending = isSearchMode ? searchPending : referencePending;
      
      console.log(`ğŸ“‹ queueRenderPage í˜¸ì¶œ: ${num}, ëª¨ë“œ: ${currentMode}, ë Œë”ë§ ì¤‘: ${isRendering}`);
      
      if (isRendering) {
        console.log(`â¸ï¸ [${currentMode}] ë Œë”ë§ ì¤‘ì´ë¯€ë¡œ í˜ì´ì§€ ${num} ëŒ€ê¸° íì— ì¶”ê°€`);
        if (isSearchMode) {
          searchPending = num;
          window.searchViewer.pending = num;
                    } else {
          referencePending = num;
          window.referenceViewer.pending = num;
        }
            } else {
        console.log(`â–¶ï¸ [${currentMode}] ì¦‰ì‹œ í˜ì´ì§€ ${num} ë Œë”ë§ ì‹œì‘`);
        renderPage(num);
      }
    }
    // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (ê²€ìƒ‰ ëª¨ë“ˆì—ì„œ ì‚¬ìš©)
    window.queueRenderPage = queueRenderPage;
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateButtons() {
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= numPages;
    }
    
    // ì´ì „ í˜ì´ì§€
    prevBtn.addEventListener('click', () => {
      if (currentPage <= 1) return;
      currentPage--;
      window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
      // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
      const currentMode = window.viewerMode || 'reference';
      if (currentMode === 'search') {
        window.searchViewer.currentPage = currentPage;
      } else {
        window.referenceViewer.currentPage = currentPage;
      }
      queueRenderPage(currentPage);
    });
    
    // ë‹¤ìŒ í˜ì´ì§€
    nextBtn.addEventListener('click', () => {
      if (currentPage >= numPages) return;
      currentPage++;
      window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
      // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
      const currentMode = window.viewerMode || 'reference';
      if (currentMode === 'search') {
        window.searchViewer.currentPage = currentPage;
      } else {
        window.referenceViewer.currentPage = currentPage;
      }
      queueRenderPage(currentPage);
    });
    
    // í˜ì´ì§€ ì…ë ¥
    pageInput.addEventListener('change', () => {
      const page = parseInt(pageInput.value, 10);
      if (page >= 1 && page <= numPages) {
        currentPage = page;
        window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        const currentMode = window.viewerMode || 'reference';
        if (currentMode === 'search') {
          window.searchViewer.currentPage = currentPage;
        } else {
          window.referenceViewer.currentPage = currentPage;
        }
        queueRenderPage(currentPage);
      } else {
        pageInput.value = currentPage;
      }
    });
    
    // ë‹«ê¸° ë²„íŠ¼
    closeBtn.addEventListener('click', () => {
      window.close();
    });
    
    // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
    searchInput.addEventListener('input', () => {
      // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”
      searchButton.disabled = !searchInput.value.trim();
    });
    
    // âœ… Enter í‚¤ë¡œ ê²€ìƒ‰ ë° ë‹¤ìŒ ê²°ê³¼ ì´ë™
    let lastSearchText = '';
    
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const searchText = searchInput.value.trim();
        
        if (!searchText) return;
        
        // ê°™ì€ ê²€ìƒ‰ì–´ì´ê³  ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ê²°ê³¼ë¡œ ì´ë™
        if (lastSearchText === searchText && 
            window.searchViewer.searchResults && window.searchViewer.searchResults.length > 0 && 
            window.searchViewer.searchIndex >= 0) {
          // ë‹¤ìŒ ê²€ìƒ‰ ê²°ê³¼ë¡œ ì´ë™
          if (window.searchViewer.searchIndex < window.searchViewer.searchResults.length - 1) {
            navigateToSearchResult(window.searchViewer.searchIndex + 1);
          } else {
            // ë§ˆì§€ë§‰ ê²°ê³¼ë©´ ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ (ìˆœí™˜)
            navigateToSearchResult(0);
          }
        } else {
          // ê²€ìƒ‰ì–´ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ê²€ìƒ‰ ìˆ˜í–‰
          lastSearchText = searchText;
          performSearch(searchText);
        }
      }
    });
    
    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    searchButton.addEventListener('click', () => {
      const searchText = searchInput.value.trim();
      if (!searchText) return;
      
      // ê°™ì€ ê²€ìƒ‰ì–´ì´ê³  ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë‹¤ìŒ ê²°ê³¼ë¡œ ì´ë™
      if (lastSearchText === searchText && 
          window.searchViewer.searchResults && window.searchViewer.searchResults.length > 0 && 
          window.searchViewer.searchIndex >= 0) {
        // ë‹¤ìŒ ê²€ìƒ‰ ê²°ê³¼ë¡œ ì´ë™
        if (window.searchViewer.searchIndex < window.searchViewer.searchResults.length - 1) {
          navigateToSearchResult(window.searchViewer.searchIndex + 1);
        } else {
          // ë§ˆì§€ë§‰ ê²°ê³¼ë©´ ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ (ìˆœí™˜)
          navigateToSearchResult(0);
        }
      } else {
        // ê²€ìƒ‰ì–´ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ê²€ìƒ‰ ìˆ˜í–‰
        lastSearchText = searchText;
        performSearch(searchText);
      }
    });
    
    // ê²€ìƒ‰ ì´ì „/ë‹¤ìŒ ë²„íŠ¼
    searchPrevBtn.addEventListener('click', () => {
      if (window.searchViewer.searchIndex > 0) {
        navigateToSearchResult(window.searchViewer.searchIndex - 1);
      }
    });
    
    searchNextBtn.addEventListener('click', () => {
      if (window.searchViewer.searchIndex < window.searchViewer.searchResults.length - 1) {
        navigateToSearchResult(window.searchViewer.searchIndex + 1);
      }
    });
    
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
      // Ctrl+F ë˜ëŠ” Cmd+Fë¡œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ (ê¸°ë³¸ ë™ì‘ ë°©ì§€)
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        searchInput.focus();
        return;
      }
      
      // ê²€ìƒ‰ ê²°ê³¼ ë„¤ë¹„ê²Œì´ì…˜ (ê²€ìƒ‰ ì¤‘ì¼ ë•Œë§Œ)
      if (window.searchViewer.searchResults && window.searchViewer.searchResults.length > 0) {
        if (e.key === 'F3' || ((e.ctrlKey || e.metaKey) && e.key === 'g')) {
          e.preventDefault();
          if (e.shiftKey) {
            // Shift+F3 ë˜ëŠ” Shift+Ctrl+G: ì´ì „ ê²°ê³¼
            if (window.searchViewer.searchIndex > 0) {
              navigateToSearchResult(window.searchViewer.searchIndex - 1);
            }
          } else {
            // F3 ë˜ëŠ” Ctrl+G: ë‹¤ìŒ ê²°ê³¼
            if (window.searchViewer.searchIndex < window.searchViewer.searchResults.length - 1) {
              navigateToSearchResult(window.searchViewer.searchIndex + 1);
            }
          }
          return;
        }
      }
      
      // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ)
      if (document.activeElement !== searchInput) {
        const currentMode = window.viewerMode || 'reference';
        
        if (e.key === 'ArrowLeft' && currentPage > 1) {
          currentPage--;
          window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
          // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
          if (currentMode === 'search') {
            window.searchViewer.currentPage = currentPage;
          } else {
            window.referenceViewer.currentPage = currentPage;
          }
          queueRenderPage(currentPage);
        } else if (e.key === 'ArrowRight' && currentPage < numPages) {
          currentPage++;
          window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
          // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
          if (currentMode === 'search') {
            window.searchViewer.currentPage = currentPage;
          } else {
            window.referenceViewer.currentPage = currentPage;
          }
          queueRenderPage(currentPage);
        }
      }
    });
    
    // âœ… í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ (ì°¸ì¡° ëª¨ë“œ ì „ìš©)
    function processChangePageMessage(data) {
      console.log('ğŸ”§ [ì°¸ì¡°] processChangePageMessage ì‹œì‘:', data);
      
      // ì°¸ì¡° ëª¨ë“œë¡œ ì „í™˜
      window.viewerMode = 'reference';
      
      console.log('ğŸ”§ [ì°¸ì¡°] í˜„ì¬ ìƒíƒœ:', {
        currentPage: window.referenceViewer.currentPage,
        numPages,
        rendering: window.referenceViewer.rendering,
        pdfDoc: !!pdfDoc
      });
      
      if (!data || !data.page || data.page <= 0) {
        console.warn('âš ï¸ [ì°¸ì¡°] ìœ íš¨í•˜ì§€ ì•Šì€ í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€:', data);
        return;
      }
      
      // í˜ì´ì§€ ë²”ìœ„ í™•ì¸
      if (numPages > 0 && data.page > numPages) {
        console.warn(`âš ï¸ [ì°¸ì¡°] ìš”ì²­ëœ í˜ì´ì§€(${data.page})ê°€ ì´ í˜ì´ì§€ ìˆ˜(${numPages})ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
        return;
      }
      
      // í˜„ì¬ í˜ì´ì§€ì™€ ê°™ì€ ê²½ìš° ìŠ¤í‚µ (ë¶ˆí•„ìš”í•œ ë Œë”ë§ ë°©ì§€)
      if (window.referenceViewer.currentPage === data.page) {
        console.log(`â„¹ï¸ [ì°¸ì¡°] ì´ë¯¸ í˜ì´ì§€ ${data.page}ì— ìˆìŒ, ìŠ¤í‚µ`);
        return;
      }
      
      console.log(`ğŸ“„ [ì°¸ì¡°] í˜ì´ì§€ ì´ë™: ${window.referenceViewer.currentPage} â†’ ${data.page}`);
      
      // ì°¸ì¡° ë·°ì–´ í˜ì´ì§€ ì—…ë°ì´íŠ¸
      currentPage = data.page;
      window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
      window.referenceViewer.currentPage = currentPage;
      
      // í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ ë³€ê²½ ì „ì— ì—…ë°ì´íŠ¸)
      if (data.highlight && Array.isArray(data.highlight)) {
        highlightKeywords.length = 0;
        highlightKeywords.push(...data.highlight);
        console.log('ğŸ“„ [ì°¸ì¡°] í•˜ì´ë¼ì´íŠ¸ í‚¤ì›Œë“œ ì—…ë°ì´íŠ¸:', highlightKeywords);
      }
      
      // ê²€ìƒ‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      if (data.searchText) {
        searchTextParam = data.searchText;
        console.log('ğŸ“„ [ì°¸ì¡°] ê²€ìƒ‰ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸:', searchTextParam.substring(0, 50) + '...');
      }
      
      // í˜ì´ì§€ ë Œë”ë§ (ì¦‰ì‹œ ì‹¤í–‰)
      console.log(`ğŸš€ [ì°¸ì¡°] queueRenderPage(${currentPage}) í˜¸ì¶œ`);
      queueRenderPage(currentPage);
      
      console.log(`âœ… [ì°¸ì¡°] í˜ì´ì§€ ${data.page}ë¡œ ì´ë™ ìš”ì²­ ì™„ë£Œ`);
    }
    
    // âœ… ë¶€ëª¨ ì°½ì—ì„œ í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', (event) => {
      // ë³´ì•ˆ: ê°™ì€ originì—ì„œë§Œ ë©”ì‹œì§€ ìˆ˜ì‹ 
      if (event.origin !== window.location.origin) {
        console.warn('âš ï¸ ë‹¤ë¥¸ originì—ì„œ ì˜¨ ë©”ì‹œì§€ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤:', event.origin);
        return;
      }
      
      const data = event.data;
      if (data && data.type === 'changePage') {
        console.log('ğŸ“¥ í˜ì´ì§€ ë³€ê²½ ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
        
        // PDFê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ íì— ì €ì¥
        if (!pdfDoc || numPages === 0) {
          console.log('â³ PDF ë¡œë“œ ì „ ë©”ì‹œì§€ ìˆ˜ì‹ , íì— ì¶”ê°€:', data);
          queuedMessages.push(data);
          return;
        }
        
        // PDFê°€ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì²˜ë¦¬
        processChangePageMessage(data);
      }
    });
    
    // âœ… ë§ˆìš°ìŠ¤ íœ ë¡œ í˜ì´ì§€ ê°„ ì´ë™ (ìŠ¤í¬ë¡¤ì´ ìƒë‹¨/í•˜ë‹¨ì— ë„ë‹¬í•˜ë©´ í˜ì´ì§€ ì´ë™)
    let wheelCooldown = false;
    viewerWrapper.addEventListener('wheel', (e) => {
      // ì¿¨ë‹¤ìš´ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (wheelCooldown) return;
      
      const wrapper = viewerWrapper;
      const scrollTop = wrapper.scrollTop;
      const scrollHeight = wrapper.scrollHeight;
      const clientHeight = wrapper.clientHeight;
      
      // ìŠ¤í¬ë¡¤ì´ ìƒë‹¨ ê·¼ì²˜ì´ê³  ìœ„ë¡œ ìŠ¤í¬ë¡¤ ì‹œ
      if (scrollTop <= 10 && e.deltaY < 0 && currentPage > 1) {
        e.preventDefault();
        wheelCooldown = true;
        currentPage--;
        window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        const currentMode = window.viewerMode || 'reference';
        if (currentMode === 'search') {
          window.searchViewer.currentPage = currentPage;
        } else {
          window.referenceViewer.currentPage = currentPage;
        }
        queueRenderPage(currentPage);
        console.log(`ğŸ“„ [${currentMode}] íœ ë¡œ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™: ${currentPage}`);
        
        // ì¿¨ë‹¤ìš´ í•´ì œ (500ms í›„)
        setTimeout(() => {
          wheelCooldown = false;
        }, 500);
      }
      // ìŠ¤í¬ë¡¤ì´ í•˜ë‹¨ ê·¼ì²˜ì´ê³  ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ ì‹œ
      else if (scrollTop + clientHeight >= scrollHeight - 10 && e.deltaY > 0 && currentPage < numPages) {
        e.preventDefault();
        wheelCooldown = true;
        currentPage++;
        window.currentPage = currentPage; // í•˜ìœ„ í˜¸í™˜ì„±
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í•´ë‹¹ ë·°ì–´ì˜ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        const currentMode = window.viewerMode || 'reference';
        if (currentMode === 'search') {
          window.searchViewer.currentPage = currentPage;
        } else {
          window.referenceViewer.currentPage = currentPage;
        }
        queueRenderPage(currentPage);
        console.log(`ğŸ“„ [${currentMode}] íœ ë¡œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™: ${currentPage}`);
        
        // ì¿¨ë‹¤ìš´ í•´ì œ (500ms í›„)
        setTimeout(() => {
          wheelCooldown = false;
        }, 500);
      }
    }, { passive: false }); // passive: falseë¡œ ì„¤ì •í•˜ì—¬ preventDefault ê°€ëŠ¥í•˜ê²Œ í•¨
  </script>
</body>
</html>
